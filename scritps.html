<script>
// Variables globales
let codigoOriginal = '';
let modulosDetectados = [];
let moduloSeleccionado = null;

// Constante con instrucciones para IA
const INSTRUCCIONES_IA = `# üîß INSTRUCCIONES DE MODULACI√ìN DE C√ìDIGO - CodeWorkShop

Para que el c√≥digo sea compatible con CodeWorkShop, sigue EXACTAMENTE estas reglas:

## üìã HEADER OBLIGATORIO

Todo archivo de c√≥digo DEBE iniciar con:

\`\`\`
/**
 * ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
 * ‚ïë PROYECTO: [Nombre del Proyecto]                         ‚ïë
 * ‚ïë ARCHIVO: [NombreArchivo.gs]                             ‚ïë
 * ‚ïë VERSI√ìN: [X.Y.Z]                                        ‚ïë
 * ‚ïë FECHA: [DD/MM/AAAA HH:MM (UTC-5)]                       ‚ïë
 * ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
 */
\`\`\`

**Ejemplo real:**
\`\`\`
/**
 * ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
 * ‚ïë PROYECTO: Sistema de Facturaci√≥n                        ‚ïë
 * ‚ïë ARCHIVO: facturacion.gs                                 ‚ïë
 * ‚ïë VERSI√ìN: 2.3.1                                          ‚ïë
 * ‚ïë FECHA: 09/01/2026 14:30 (UTC-5)                         ‚ïë
 * ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
 */
\`\`\`

---

## üß© MODULACI√ìN DE FUNCIONES

Cada funci√≥n o secci√≥n l√≥gica DEBE estar delimitada as√≠:

\`\`\`
// MOD-001: DESCRIPCI√ìN EN MAY√öSCULAS [INICIO]
function miFuncion() {
  // c√≥digo aqu√≠
}
// MOD-001: FIN
\`\`\`

**Ejemplo completo:**
\`\`\`
// MOD-001: VALIDACI√ìN DE DATOS [INICIO]
function validarDatos(datos) {
  if (!datos || datos.length === 0) {
    throw new Error("Datos vac√≠os");
  }
  return true;
}
// MOD-001: FIN

// MOD-002: PROCESAMIENTO PRINCIPAL [INICIO]
function procesarFactura(factura) {
  validarDatos(factura);
  const resultado = calcularTotal(factura);
  return resultado;
}
// MOD-002: FIN

// MOD-003: C√ÅLCULO DE TOTALES [INICIO]
function calcularTotal(factura) {
  return factura.items.reduce((sum, item) => sum + item.precio, 0);
}
// MOD-003: FIN
\`\`\`

---

## ‚ö†Ô∏è REGLAS CR√çTICAS

### 1. Numeraci√≥n Secuencial
- ‚úÖ Usar: MOD-001, MOD-002, MOD-003...
- ‚ùå NO saltar n√∫meros: MOD-001, MOD-005, MOD-003
- ‚ùå NO repetir n√∫meros

### 2. Etiquetas Obligatorias
- **[INICIO]** es OBLIGATORIO (con corchetes)
- **FIN** DEBE tener el MISMO n√∫mero que INICIO
- Ejemplo correcto:
  \`\`\`
  // MOD-007: FUNCI√ìN [INICIO]
  function test() {}
  // MOD-007: FIN
  \`\`\`

### 3. Descripci√≥n
- Siempre en MAY√öSCULAS
- Clara y concisa
- Describe la funci√≥n del m√≥dulo

### 4. NO usar MOD-XXX dentro del c√≥digo
- ‚ùå Incorrecto:
  \`\`\`
  // MOD-001: FUNCI√ìN [INICIO]
  function test() {
    // Este es el MOD-001 que hace... ‚Üê NO HACER ESTO
  }
  // MOD-001: FIN
  \`\`\`
- ‚úÖ Correcto:
  \`\`\`
  // MOD-001: FUNCI√ìN [INICIO]
  function test() {
    // Esta funci√≥n valida los datos de entrada
  }
  // MOD-001: FIN
  \`\`\`

---

## üîÑ CUANDO MODIFICAS C√ìDIGO EXISTENTE

**REGLA DE ORO:** Si el c√≥digo YA tiene m√≥dulos, SOLO entrega el m√≥dulo modificado.

### ‚ùå INCORRECTO - NO hagas esto:
\`\`\`
[Usuario pide modificar la funci√≥n de validaci√≥n]

[IA responde con TODO el archivo completo de 500 l√≠neas]
\`\`\`

### ‚úÖ CORRECTO - Haz esto:
\`\`\`
[Usuario pide modificar la funci√≥n de validaci√≥n]

[IA responde SOLO con:]

// MOD-001: VALIDACI√ìN DE DATOS [INICIO]
function validarDatos(datos) {
  // NUEVA l√≥gica de validaci√≥n mejorada
  if (!datos) throw new Error("Datos nulos");
  if (!Array.isArray(datos)) throw new Error("Datos no son array");
  return true;
}
// MOD-001: FIN
\`\`\`

**El usuario usar√° CodeWorkShop para reemplazar SOLO ese m√≥dulo en el c√≥digo completo.**

---

## üéØ RESUMEN R√ÅPIDO

**Siempre incluye:**
1. Header con PROYECTO, ARCHIVO, VERSI√ìN, FECHA
2. M√≥dulos con MOD-XXX: DESCRIPCI√ìN [INICIO]
3. Cierre con MOD-XXX: FIN (mismo n√∫mero)
4. Numeraci√≥n secuencial sin saltos

**Cuando modificas:**
- SOLO entrega el m√≥dulo modificado
- Mant√©n el n√∫mero MOD-XXX original
- Incluye [INICIO] y FIN completos

**Nunca hagas:**
- Entregar todo el archivo si solo se modific√≥ una funci√≥n
- Cambiar n√∫meros de m√≥dulos existentes
- Olvidar [INICIO] o FIN
- Usar MOD-XXX dentro de comentarios de c√≥digo

---

‚úÖ **Listo para usar con CodeWorkShop**`;

// MOD-001: COPIAR INSTRUCCIONES IA [INICIO]
function copiarInstruccionesIA() {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(INSTRUCCIONES_IA)
      .then(() => {
        mostrarNotificacion('‚úÖ Instrucciones copiadas al portapapeles', 'success');
        console.log('üìã Instrucciones IA copiadas correctamente');
      })
      .catch(err => {
        copiarInstruccionesFallback();
      });
  } else {
    copiarInstruccionesFallback();
  }
}

function copiarInstruccionesFallback() {
  const textarea = document.createElement('textarea');
  textarea.value = INSTRUCCIONES_IA;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    const exitoso = document.execCommand('copy');
    if (exitoso) {
      mostrarNotificacion('‚úÖ Instrucciones copiadas al portapapeles', 'success');
      console.log('üìã Instrucciones IA copiadas (fallback)');
    } else {
      throw new Error('execCommand fall√≥');
    }
  } catch (err) {
    mostrarNotificacion('‚ùå No se pudo copiar. Usa Ctrl+C manualmente', 'error');
    console.error('Error al copiar:', err);
    mostrarModalInstrucciones();
  } finally {
    document.body.removeChild(textarea);
  }
}

function mostrarModalInstrucciones() {
  const modal = document.createElement('div');
  modal.className = 'modal-instrucciones';
  modal.innerHTML = `
    <div class="modal-content">
      <h3>üìã Instrucciones para IA</h3>
      <p>Selecciona todo el texto y copia con Ctrl+C:</p>
      <textarea readonly style="width:100%; height:400px; font-family:monospace;">
${INSTRUCCIONES_IA}
      </textarea>
      <button onclick="this.closest('.modal-instrucciones').remove()">Cerrar</button>
    </div>
  `;
  document.body.appendChild(modal);
}
// MOD-001: FIN

// MOD-002: ANALIZAR M√ìDULOS [INICIO]
function analizarModulos() {
  const codigo = document.getElementById('codigoOriginal').value;
  
  if (!codigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Por favor, carga el c√≥digo primero', 'warning');
    return;
  }
  
  if (!codigo.includes('MOD-')) {
    mostrarNotificacion('‚ö†Ô∏è No se detectaron m√≥dulos en el c√≥digo', 'warning');
    return;
  }
  
  mostrarCargando(true);
  console.log('üì• C√≥digo cargado:', codigo.length, 'caracteres');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarCargando(false);
      
      if (!resultado.success) {
        mostrarNotificacion(resultado.error, 'error');
        console.error('Error al parsear:', resultado);
        return;
      }
      
      codigoOriginal = codigo;
      modulosDetectados = resultado.modulos;
      mostrarModulos(resultado.modulos);
      mostrarNotificacion('‚úÖ M√≥dulos detectados: ' + resultado.modulos.length, 'success');
      console.log('üîç M√≥dulos detectados:', resultado.modulos);
    })
    .withFailureHandler(function(error) {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
      console.error('Error fatal:', error);
    })
    .parsearModulos(codigo);
}
// MOD-002: FIN

// MOD-003: MOSTRAR M√ìDULOS [INICIO]
function mostrarModulos(modulos) {
  const lista = document.getElementById('listaModulos');
  lista.innerHTML = '';
  
  modulos.forEach((modulo, index) => {
    const item = document.createElement('div');
    item.className = 'modulo-item';
    item.onclick = () => seleccionarModulo(index);
    
    item.innerHTML = `
      <span class="modulo-numero">MOD-${modulo.numero}</span>
      <span class="modulo-descripcion">${modulo.descripcion}</span>
    `;
    
    lista.appendChild(item);
  });
  
  document.getElementById('seccionModulos').style.display = 'block';
}
// MOD-003: FIN

// MOD-004: SELECCIONAR M√ìDULO [INICIO]
function seleccionarModulo(index) {
  moduloSeleccionado = modulosDetectados[index];
  
  document.querySelectorAll('.modulo-item').forEach((item, i) => {
    if (i === index) {
      item.classList.add('selected');
    } else {
      item.classList.remove('selected');
    }
  });
  
  document.getElementById('moduloActual').value = moduloSeleccionado.codigo;
  document.getElementById('seccionModuloActual').style.display = 'block';
  document.getElementById('seccionNuevoModulo').style.display = 'block';
  
  mostrarNotificacion('‚úÖ M√≥dulo MOD-' + moduloSeleccionado.numero + ' seleccionado', 'info');
  console.log('üìå M√≥dulo seleccionado:', moduloSeleccionado);
}
// MOD-004: FIN

// MOD-005: APLICAR CAMBIO [INICIO]
function aplicarCambio() {
  if (!validarAntesDeEnviar()) {
    return;
  }
  
  const nuevoModulo = document.getElementById('nuevoModulo').value;
  
  mostrarCargando(true);
  console.log('üîÑ Aplicando cambio al m√≥dulo MOD-' + moduloSeleccionado.numero);
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarCargando(false);
      
      if (!resultado.success) {
        mostrarNotificacion(resultado.error, 'error');
        console.error('Error al reemplazar:', resultado);
        return;
      }
      
      document.getElementById('codigoResultante').value = resultado.codigo;
      document.getElementById('seccionResultado').style.display = 'block';
      mostrarNotificacion('‚úÖ Cambio aplicado correctamente', 'success');
      console.log('‚úÖ C√≥digo actualizado');
      
      document.getElementById('codigoResultante').scrollIntoView({ behavior: 'smooth' });
    })
    .withFailureHandler(function(error) {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al aplicar cambio', 'error');
      console.error('Error fatal:', error);
    })
    .reemplazarModulo(codigoOriginal, moduloSeleccionado.numero, nuevoModulo);
}
// MOD-005: FIN

// MOD-006: VALIDAR ANTES DE ENVIAR [INICIO]
function validarAntesDeEnviar() {
  if (!codigoOriginal) {
    mostrarNotificacion('‚ö†Ô∏è Primero carga el c√≥digo original', 'warning');
    return false;
  }
  
  if (!moduloSeleccionado) {
    mostrarNotificacion('‚ö†Ô∏è Selecciona un m√≥dulo', 'warning');
    return false;
  }
  
  const nuevoCodigo = document.getElementById('nuevoModulo').value;
  if (!nuevoCodigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è El nuevo c√≥digo est√° vac√≠o', 'warning');
    return false;
  }
  
  return true;
}
// MOD-006: FIN

// MOD-007: COPIAR RESULTADO [INICIO]
function copiarResultado() {
  const codigo = document.getElementById('codigoResultante').value;
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(codigo)
      .then(() => {
        mostrarNotificacion('‚úÖ C√≥digo copiado al portapapeles', 'success');
      })
      .catch(() => {
        copiarResultadoFallback();
      });
  } else {
    copiarResultadoFallback();
  }
}

function copiarResultadoFallback() {
  const textarea = document.getElementById('codigoResultante');
  textarea.select();
  
  try {
    document.execCommand('copy');
    mostrarNotificacion('‚úÖ C√≥digo copiado al portapapeles', 'success');
  } catch (err) {
    mostrarNotificacion('‚ùå No se pudo copiar', 'error');
  }
}
// MOD-007: FIN

// MOD-008: REINICIAR [INICIO]
function reiniciar() {
  document.getElementById('codigoOriginal').value = '';
  document.getElementById('nuevoModulo').value = '';
  document.getElementById('codigoResultante').value = '';
  
  document.getElementById('seccionModulos').style.display = 'none';
  document.getElementById('seccionModuloActual').style.display = 'none';
  document.getElementById('seccionNuevoModulo').style.display = 'none';
  document.getElementById('seccionResultado').style.display = 'none';
  
  codigoOriginal = '';
  modulosDetectados = [];
  moduloSeleccionado = null;
  
  mostrarNotificacion('üîÑ Listo para nueva modificaci√≥n', 'info');
  console.log('üîÑ Aplicaci√≥n reiniciada');
}
// MOD-008: FIN

// MOD-009: NOTIFICACIONES [INICIO]
function mostrarNotificacion(mensaje, tipo = 'success') {
  const toast = document.getElementById('toast');
  const iconos = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  toast.innerHTML = `${iconos[tipo]} ${mensaje}`;
  toast.className = `toast ${tipo} show`;
  
  setTimeout(() => {
    toast.className = 'toast';
  }, 3000);
}
// MOD-009: FIN

// MOD-010: LOADING OVERLAY [INICIO]
function mostrarCargando(mostrar) {
  const loading = document.getElementById('loading');
  if (mostrar) {
    loading.classList.add('show');
  } else {
    loading.classList.remove('show');
  }
}
// MOD-010: FIN
</script>
