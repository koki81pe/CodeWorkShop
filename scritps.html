<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: CodeWorkShop
ARCHIVO: scripts.html
VERSIÓN: 01.13
FECHA: 15/01/2026 08:16 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: SCRIPT PRINCIPAL [INICIO] -->
<script>


// VARIABLES GLOBALES
let codigoOriginal = '';
let modulosDetectados = [];
let moduloSeleccionado = null;


// UTILIDAD: ESCAPAR HTML (SOLO UI GENERAL)
// ⚠️ NO USAR PARA MODS
function escaparHTML(texto) {
  return texto
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}


// ANALIZAR MODS
function analizarModulos() {
  const codigo = document.getElementById('codigoOriginal').value;

  if (!codigo.trim()) {
    mostrarNotificacion('⚠️ Carga un código primero', 'warning');
    return;
  }

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }

      codigoOriginal = codigo;
      modulosDetectados = res.modulos;

      mostrarModulos(modulosDetectados);
      mostrarNotificacion(`✅ ${res.modulos.length} MODs detectados`, 'success');
    })
    .withFailureHandler(() => {
      mostrarCargando(false);
      mostrarNotificacion('❌ Error al analizar', 'error');
    })
    .parsearModulos(codigo);
}


// UI MODS
function mostrarModulos(modulos) {
  const lista = document.getElementById('listaModulos');
  lista.innerHTML = '';

  modulos.forEach((mod, index) => {
    const item = document.createElement('div');
    item.className = 'modulo-item';
    item.onclick = () => seleccionarModulo(index);
    item.textContent = `MOD-${mod.id}: ${mod.descripcion}`;
    lista.appendChild(item);
  });

  document.getElementById('seccionModulos').style.display = 'block';
}

function seleccionarModulo(index) {
  moduloSeleccionado = modulosDetectados[index];

  document.querySelectorAll('.modulo-item').forEach((el, i) => {
    el.classList.toggle('selected', i === index);
  });

  // ✅ MOSTRAR EL MOD TAL CUAL ES (SIN ESCAPAR)
  const campoActual = document.getElementById('moduloActual');
  campoActual.value = moduloSeleccionado.codigo;
  campoActual.readOnly = true;

  document.getElementById('seccionModuloActual').style.display = 'block';
  document.getElementById('seccionNuevoModulo').style.display = 'block';

  mostrarNotificacion(
    `ℹ️ MOD-${moduloSeleccionado.id} seleccionado`,
    'info'
  );
}


// REEMPLAZO
function aplicarCambio() {
  if (!codigoOriginal || !moduloSeleccionado) {
    mostrarNotificacion('⚠️ Falta código o módulo', 'warning');
    return;
  }

  const nuevoModulo = document.getElementById('nuevoModulo').value;
  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }

      document.getElementById('codigoResultante').value = res.codigo;
      document.getElementById('seccionResultado').style.display = 'block';

      mostrarNotificacion('✅ Módulo reemplazado', 'success');
    })
    .withFailureHandler(() => {
      mostrarCargando(false);
      mostrarNotificacion('❌ Error al aplicar cambio', 'error');
    })
    .reemplazarModulo(codigoOriginal, moduloSeleccionado.id, nuevoModulo);
}


// UTILIDADES UI
function copiarResultado() {
  navigator.clipboard.writeText(
    document.getElementById('codigoResultante').value
  );
}

function reiniciar() {
  codigoOriginal = '';
  modulosDetectados = [];
  moduloSeleccionado = null;
}

function mostrarNotificacion(msg, tipo = 'success') {
  const toast = document.getElementById('toast');
  toast.className = `toast ${tipo} show`;
  toast.textContent = msg;
  setTimeout(() => toast.className = 'toast', 3000);
}

function mostrarCargando(show) {
  document.getElementById('loading')
    .classList.toggle('show', show);
}

// ACCIONES DE HEADER (BOTONES)

// Copiar URL del PDF del estándar
function copiarUrlPdfEstandar() {
  const urlPdf =
    'https://docs.google.com/document/d/1vbbaAPpTN9nQed_OOtoQBIp9K3PfNn5wgXWhNELAhqA/export?format=pdf';

  navigator.clipboard.writeText(urlPdf);
  mostrarNotificacion('✅ URL del estándar copiada', 'success');
}

// Copiar contenido del estándar para IA
function copiarInstruccionesIA() {
  google.script.run
    .withSuccessHandler(res => {
      if (!res || !res.success) {
        mostrarNotificacion(
          res?.error || '❌ Error al obtener estándar',
          'error'
        );
        return;
      }

      navigator.clipboard.writeText(res.texto);
      mostrarNotificacion(
        '✅ Estándar copiado al portapapeles',
        'success'
      );
    })
    .withFailureHandler(() => {
      mostrarNotificacion(
        '❌ Error al leer el estándar',
        'error'
      );
    })
    .obtenerEstandar();
}

// Abrir página de Tests
function abrirTests() {
  google.script.run
    .withSuccessHandler(url => {
      if (url) {
        window.open(url, '_blank');
      } else {
        mostrarNotificacion(
          '❌ No se pudo obtener la URL de Tests',
          'error'
        );
      }
    })
    .withFailureHandler(() => {
      mostrarNotificacion(
        '❌ Error al abrir Tests',
        'error'
      );
    })
    .obtenerURLTests();
}

console.log('✅ Scripts CodeWorkShop v2.7 cargados');

</script>
<!-- MOD-002: FIN -->

<!-- MOD-003: NOTAS [INICIO] -->
<!--
scripts.html NO analiza código.
scripts.html NO modifica MODs.
scripts.html SOLO muestra y envía texto crudo.

Toda la lógica vive en:
- code.gs (MOD-006, MOD-008, MOD-009)
-->
<!-- MOD-003: FIN -->
