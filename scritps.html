<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: CodeWorkShop
ARCHIVO: scripts.html
VERSI√ìN: 01.38
FECHA: 10/02/2026 15:40 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: SCRIPT PRINCIPAL [INICIO] -->
<script>

// MOD-002-001: VARIABLES GLOBALES [INICIO]
let codigoOriginal = '';
let modulosDetectados = [];
let moduloSeleccionado = null;
let modoEdicion = null; // 'multiMod', 'nuevoMod' o 'eliminarMod'
let modulosAEliminar = []; // IDs de m√≥dulos marcados para eliminar
// MOD-002-001: FIN


  // MOD-002-002: UTILIDADES GENERALES [INICIO]

  // UTILIDAD: ESCAPAR HTML (SOLO UI GENERAL)
  // ‚ö†Ô∏è NO USAR PARA MODS
  function escaparHTML(texto) {
    return texto
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }
  // MOD-002-002: FIN


// MOD-002-003: ANALISIS DE MODULOS V3 [INICIO]

function analizarModulos(modo) {
  const codigo = document.getElementById('codigoOriginal').value;

  if (!codigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Carga un c√≥digo primero', 'warning');
    return;
  }

  // Guardar el modo de edici√≥n seleccionado
  modoEdicion = modo;

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }

      codigoOriginal = codigo;
      modulosDetectados = res.modulos;

      // üÜï Renderizar seg√∫n modo
      if (modo === 'eliminarMod') {
        mostrarModulosParaEliminar(modulosDetectados);
      } else {
        mostrarModulos(modulosDetectados);
      }
      
      configurarModoEdicion(modo);
      
      // üÜï MOSTRAR ESTAD√çSTICAS
      if (res.estadisticas) {
        const stats = res.estadisticas;
        const mensaje = `‚úÖ Detectados: ${stats.total} MOD = ${stats.padres} MOD + ${stats.hijos} SubMOD`;
        mostrarNotificacion(mensaje, 'success');
      } else {
        // Fallback si no hay estad√≠sticas
        mostrarNotificacion(`‚úÖ ${res.modulos.length} MODs detectados`, 'success');
      }
    })
    .withFailureHandler(() => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al analizar', 'error');
    })
    .parsearModulos(codigo);
}

// MOD-002-003: FIN

// MOD-002-004: UI ‚Äì LISTADO Y SELECCION DE MODS V4 [INICIO]
function mostrarModulos(modulos) {
  const lista = document.getElementById('listaModulos');
  lista.innerHTML = '';

  modulos.forEach((mod, index) => {
    const item = document.createElement('div');
    item.className = 'modulo-item';
    item.onclick = () => seleccionarModulo(index);
    
    // üÜï MOSTRAR L√çNEAS AL LADO DE LA DESCRIPCI√ìN
    const textoLineas = mod.lineas ? ` (${mod.lineas} l√≠neas)` : '';
    item.textContent = `${mod.id} ${mod.descripcion}${textoLineas}`;
    
    lista.appendChild(item);
  });

  document.getElementById('seccionModulos').style.display = 'block';
  
  // Asegurar que la lista est√© expandida al cargar
  const listaElement = document.getElementById('listaModulos');
  const btnCollapse = document.getElementById('btnCollapseModulos');
  listaElement.classList.remove('collapsed');
  btnCollapse.textContent = '‚ñº';
  
  // Ocultar controles de eliminaci√≥n
  document.getElementById('controlesEliminar').style.display = 'none';
  
  // Actualizar t√≠tulo
  document.getElementById('tituloSeccionModulos').textContent = '2. Seleccionar M√≥dulo a Modificar';
}

function seleccionarModulo(index) {
  moduloSeleccionado = modulosDetectados[index];
  
  document.querySelectorAll('.modulo-item').forEach((el, i) => {
    el.classList.toggle('selected', i === index);
  });
  
  const campoActual = document.getElementById('moduloActual');
  campoActual.value = moduloSeleccionado.codigo;
  campoActual.readOnly = true;

  // üÜï MOSTRAR Y EXPANDIR SECCI√ìN 3
  document.getElementById('seccionModuloActual').style.display = 'block';
  const contenidoSec3 = document.getElementById('contenidoSec3');
  const btnCollapseSec3 = document.getElementById('btnCollapseSec3');
  contenidoSec3.classList.remove('collapsed');
  btnCollapseSec3.textContent = '‚ñº';

  // üÜï MOSTRAR Y EXPANDIR SECCI√ìN 4
  document.getElementById('seccionNuevoModulo').style.display = 'block';
  const contenidoSec4 = document.getElementById('contenidoSec4');
  const btnCollapseSec4 = document.getElementById('btnCollapseSec4');
  contenidoSec4.classList.remove('collapsed');
  btnCollapseSec4.textContent = '‚ñº';

  mostrarNotificacion(`‚ÑπÔ∏è ${moduloSeleccionado.id} seleccionado`, 'info');
}

function toggleModulos() {
  const lista = document.getElementById('listaModulos');
  const btnCollapse = document.getElementById('btnCollapseModulos');
  
  lista.classList.toggle('collapsed');
  
  if (lista.classList.contains('collapsed')) {
    btnCollapse.textContent = '‚ñ∂';
  } else {
    btnCollapse.textContent = '‚ñº';
  }
}

function configurarModoEdicion(modo) {
  const checkboxAgregar = document.getElementById('checkboxReenumAgregar');
  
  if (modo === 'eliminarMod') {
    // MODO ELIMINAR: No mostrar Secci√≥n 3 ni 4
    document.getElementById('seccionModuloActual').style.display = 'none';
    document.getElementById('seccionNuevoModulo').style.display = 'none';
    
    // Ocultar checkbox de agregar
    if (checkboxAgregar) {
      checkboxAgregar.style.display = 'none';
    }
  } else {
    // MODO NORMAL: Mostrar y expandir secci√≥n de nuevo m√≥dulo
    document.getElementById('seccionNuevoModulo').style.display = 'block';
    const contenidoSec4 = document.getElementById('contenidoSec4');
    const btnCollapseSec4 = document.getElementById('btnCollapseSec4');
    contenidoSec4.classList.remove('collapsed');
    btnCollapseSec4.textContent = '‚ñº';
    
    // üÜï Mostrar checkbox solo en modo "Agregar MOD"
    if (checkboxAgregar) {
      checkboxAgregar.style.display = modo === 'nuevoMod' ? 'flex' : 'none';
    }
  }
}
// MOD-002-004: FIN

// MOD-002-005: REEMPLAZO DE MODULOS [INICIO]
function aplicarCambio() {
  if (!codigoOriginal) {
    mostrarNotificacion('‚ö†Ô∏è Falta c√≥digo original', 'warning');
    return;
  }

  // Detectar el modo y ejecutar la funci√≥n correspondiente
  if (modoEdicion === 'multiMod') {
    aplicarCambioMultiple();
  } 
  else if (modoEdicion === 'nuevoMod') {
    aplicarCambioNuevo();
  }
}

function aplicarCambioMultiple() {
  const multiModulo = document.getElementById('multiModulo').value;
  
  if (!multiModulo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Pega los m√≥dulos a reemplazar', 'warning');
    return;
  }

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }

      document.getElementById('codigoResultante').value = res.codigo;
      document.getElementById('seccionResultado').style.display = 'block';

      mostrarNotificacion(`‚úÖ ${res.modulosReemplazados} m√≥dulos reemplazados`, 'success');
    })
    .withFailureHandler(() => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al aplicar cambios m√∫ltiples', 'error');
    })
    .reemplazarMultiplesModulos(
      codigoOriginal,
      multiModulo
    );
}
// MOD-002-005: FIN


// MOD-002-006: UTILIDADES UI V2 [INICIO]
function copiarResultado() {
  navigator.clipboard.writeText(
    document.getElementById('codigoResultante').value
  );
  mostrarNotificacion('‚úÖ C√≥digo copiado al portapapeles', 'success');
}

function reiniciar() {
  codigoOriginal = '';
  modulosDetectados = [];
  moduloSeleccionado = null;
}

function mostrarNotificacion(msg, tipo = 'success') {
  const toast = document.getElementById('toast');
  toast.className = `toast ${tipo} show`;
  toast.textContent = msg;
  setTimeout(() => toast.className = 'toast', 3000);
}

function mostrarCargando(show) {
  document
    .getElementById('loading')
    .classList.toggle('show', show);
}
// MOD-002-006: FIN


// MOD-002-007: ACCIONES DE HEADER [INICIO]
  function copiarUrlPdfEstandar() {
    const urlPdf =
      'https://docs.google.com/document/d/1vbbaAPpTN9nQed_OOtoQBIp9K3PfNn5wgXWhNELAhqA/export?format=pdf';

    navigator.clipboard.writeText(urlPdf);
    mostrarNotificacion('‚úÖ URL del est√°ndar copiada', 'success');
  }

  function copiarInstruccionesIA() {
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.success) {
          mostrarNotificacion(
            res?.error || '‚ùå Error al obtener est√°ndar',
            'error'
          );
          return;
        }

        navigator.clipboard.writeText(res.texto);
        mostrarNotificacion(
          '‚úÖ Est√°ndar copiado al portapapeles',
          'success'
        );
      })
      .withFailureHandler(() => {
        mostrarNotificacion(
          '‚ùå Error al leer el est√°ndar',
          'error'
        );
      })
      .obtenerEstandar();
  }
  // MOD-002-007: FIN


// MOD-002-008: LOG Y ARRANQUE [INICIO]
console.log('‚úÖ Scripts CodeWorkShop v01.33 cargados');
// MOD-002-008: FIN

// MOD-002-009: AGREGAR MOD H√çBRIDO V3 [INICIO]
function aplicarCambioNuevo() {
  const nuevoModulo = document.getElementById('multiModulo').value;
  
  if (!nuevoModulo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Pega los m√≥dulos en el √°rea inferior', 'warning');
    return;
  }

  // üÜï Capturar checkbox de reenumeraci√≥n
  const reenumerar = document.getElementById('checkReenumAgregar').checked;

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);
      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }
      document.getElementById('codigoResultante').value = res.codigo;
      document.getElementById('seccionResultado').style.display = 'block';
      
      // üÜï Mensaje mejorado con informaci√≥n de reenumeraci√≥n
      let mensaje = '';
      if (res.accionRealizada === 'reemplazado') {
        mensaje = '‚úÖ M√≥dulo(s) reemplazado(s)';
      } else {
        mensaje = `‚úÖ ${res.modulosProcesados} m√≥dulo(s) procesado(s)`;
      }
      
      if (reenumerar && res.reenumerado) {
        mensaje += ' + reenumerado';
      }
      
      mostrarNotificacion(mensaje, 'success');
    })
    .withFailureHandler(err => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error del servidor: ' + err, 'error');
    })
    .agregarModuloNuevo(codigoOriginal, nuevoModulo, reenumerar);
}
// MOD-002-009: FIN

// MOD-002-010: REENUMERAR C√ìDIGO [INICIO]
/**
 * Reenumera todos los m√≥dulos del c√≥digo cargado.
 * Ejecuta el proceso completo en 3 etapas:
 * - Etapa 1: Reenumerar padres + herencia
 * - Etapa 2: Reenumerar hijos intermedios
 * - Conversi√≥n: √öltimo MOD ‚Üí MOD-099
 */
function reenumerarCodigo() {
  const codigo = document.getElementById('codigoOriginal').value;

  if (!codigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Carga un c√≥digo primero', 'warning');
    return;
  }

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error || '‚ùå Error al reenumerar', 'error');
        return;
      }

      // Si no hab√≠a cambios necesarios
      if (res.mensaje) {
        mostrarNotificacion(res.mensaje, 'info');
        return;
      }

      // Mostrar c√≥digo reenumerado en secci√≥n de resultado
      document.getElementById('codigoResultante').value = res.codigo;
      document.getElementById('seccionResultado').style.display = 'block';

      // Mostrar estad√≠sticas si est√°n disponibles
      if (res.estadisticas) {
        const stats = res.estadisticas;
        const totalCambios = stats.etapa1.modulosProcesados + stats.etapa2.modulosProcesados;
        const mensaje = `‚úÖ Reenumeraci√≥n completa: ${totalCambios} cambio(s) | Etapa 1: ${stats.etapa1.modulosProcesados} | Etapa 2: ${stats.etapa2.modulosProcesados}`;
        mostrarNotificacion(mensaje, 'success');
      } else {
        mostrarNotificacion('‚úÖ Reenumeraci√≥n completada exitosamente', 'success');
      }
    })
    .withFailureHandler(err => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al reenumerar: ' + err, 'error');
    })
    .reenumerarModulosCompleto(codigo);
}
// MOD-002-010: FIN

// MOD-002-011: FUNCIONES TOGGLE SECCIONES [INICIO]
/**
 * Funciones para colapsar/expandir secciones 1, 3, 4, 5.
 * Mantiene botones visibles, solo colapsa contenido.
 */

function toggleSeccion1() {
  const contenido = document.getElementById('contenidoSec1');
  const btnCollapse = document.getElementById('btnCollapseSec1');
  
  contenido.classList.toggle('collapsed');
  
  if (contenido.classList.contains('collapsed')) {
    btnCollapse.textContent = '‚ñ∂';
  } else {
    btnCollapse.textContent = '‚ñº';
  }
}

function toggleSeccion3() {
  const contenido = document.getElementById('contenidoSec3');
  const btnCollapse = document.getElementById('btnCollapseSec3');
  
  contenido.classList.toggle('collapsed');
  
  if (contenido.classList.contains('collapsed')) {
    btnCollapse.textContent = '‚ñ∂';
  } else {
    btnCollapse.textContent = '‚ñº';
  }
}

function toggleSeccion4() {
  const contenido = document.getElementById('contenidoSec4');
  const btnCollapse = document.getElementById('btnCollapseSec4');
  
  contenido.classList.toggle('collapsed');
  
  if (contenido.classList.contains('collapsed')) {
    btnCollapse.textContent = '‚ñ∂';
  } else {
    btnCollapse.textContent = '‚ñº';
  }
}

function toggleSeccion5() {
  const contenido = document.getElementById('contenidoSec5');
  const btnCollapse = document.getElementById('btnCollapseSec5');
  
  contenido.classList.toggle('collapsed');
  
  if (contenido.classList.contains('collapsed')) {
    btnCollapse.textContent = '‚ñ∂';
  } else {
    btnCollapse.textContent = '‚ñº';
  }
}
// MOD-002-011: FIN

// MOD-002-012: ELIMINAR M√ìDULOS [INICIO]
/**
 * Renderiza lista de m√≥dulos con checkboxes para modo eliminaci√≥n.
 * Oculta Secci√≥n 3 y muestra controles de eliminaci√≥n.
 */
function mostrarModulosParaEliminar(modulos) {
  const lista = document.getElementById('listaModulos');
  lista.innerHTML = '';
  
  // Resetear array de m√≥dulos a eliminar
  modulosAEliminar = [];

  modulos.forEach((mod, index) => {
    const item = document.createElement('div');
    item.className = 'modulo-item';
    
    // Crear checkbox
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'modulo-checkbox';
    checkbox.id = `check-${index}`;
    checkbox.dataset.modId = mod.id;
    
    // Bloquear MOD-001 y MOD-099
    if (mod.id === 'MOD-001:' || mod.id === 'MOD-099:') {
      checkbox.disabled = true;
      item.style.opacity = '0.5';
      item.title = 'No se puede eliminar este m√≥dulo';
    }
    
    checkbox.onchange = (e) => toggleCheckbox(e, mod.id);
    
    // Texto del m√≥dulo
    const textoLineas = mod.lineas ? ` (${mod.lineas} l√≠neas)` : '';
    const label = document.createElement('label');
    label.htmlFor = `check-${index}`;
    label.textContent = `${mod.id} ${mod.descripcion}${textoLineas}`;
    label.style.cursor = 'pointer';
    label.style.flex = '1';
    
    // Click en el item marca/desmarca el checkbox
    item.onclick = (e) => {
      if (e.target !== checkbox && !checkbox.disabled) {
        checkbox.checked = !checkbox.checked;
        toggleCheckbox({ target: checkbox }, mod.id);
      }
    };
    
    item.appendChild(checkbox);
    item.appendChild(label);
    lista.appendChild(item);
  });

  document.getElementById('seccionModulos').style.display = 'block';
  
  // Expandir lista
  const listaElement = document.getElementById('listaModulos');
  const btnCollapse = document.getElementById('btnCollapseModulos');
  listaElement.classList.remove('collapsed');
  btnCollapse.textContent = '‚ñº';
  
  // Mostrar controles de eliminaci√≥n
  document.getElementById('controlesEliminar').style.display = 'flex';
  
  // Actualizar t√≠tulo
  document.getElementById('tituloSeccionModulos').textContent = '2. Seleccionar M√≥dulos a Eliminar';
}

/**
 * Maneja el cambio de estado de un checkbox.
 */
function toggleCheckbox(event, modId) {
  if (event.target.checked) {
    // Agregar a la lista
    if (!modulosAEliminar.includes(modId)) {
      modulosAEliminar.push(modId);
    }
  } else {
    // Quitar de la lista
    modulosAEliminar = modulosAEliminar.filter(id => id !== modId);
  }
}

/**
 * Confirma y ejecuta la eliminaci√≥n de m√≥dulos marcados.
 */
function confirmarEliminacion() {
  if (modulosAEliminar.length === 0) {
    mostrarNotificacion('‚ö†Ô∏è No has seleccionado ning√∫n m√≥dulo', 'warning');
    return;
  }
  
  const reenumerar = document.getElementById('checkReenumEliminar').checked;
  const cantidad = modulosAEliminar.length;
  
  // Construir mensaje
  let mensaje = `Se eliminar√°n ${cantidad} m√≥dulo(s).`;
  if (reenumerar) {
    mensaje += '\n\nSe reenumerar√° autom√°ticamente despu√©s.';
  }
  
  // Mostrar modal personalizado
  mostrarModal('‚ö†Ô∏è Confirmar Eliminaci√≥n', mensaje, () => {
    ejecutarEliminacion(reenumerar);
  });
}

/**
 * Ejecuta la eliminaci√≥n despu√©s de confirmar.
 */
function ejecutarEliminacion(reenumerar) {
  mostrarCargando(true);

  // üîπ CR√çTICO: Capturar los IDs ANTES de la llamada as√≠ncrona
  const idsAEliminar = [...modulosAEliminar];

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }

      // Mostrar resultado
      document.getElementById('codigoResultante').value = res.codigo;
      document.getElementById('seccionResultado').style.display = 'block';

      // Mensaje de √©xito
      let mensaje = `‚úÖ ${res.eliminados} m√≥dulo(s) eliminado(s)`;
      if (res.deduplicados > 0) {
        mensaje += ` (${res.deduplicados} redundancia(s) ignorada(s))`;
      }
      
      mostrarNotificacion(mensaje, 'success');
      
      // Resetear UI
      modulosAEliminar = [];
      document.getElementById('seccionModulos').style.display = 'none';
    })
    .withFailureHandler(err => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al eliminar: ' + err, 'error');
    })
    .eliminarModulos(codigoOriginal, idsAEliminar, reenumerar);
}
// MOD-002-012: FIN

// MOD-002-013: MODAL DE CONFIRMACI√ìN [INICIO]
let modalCallback = null;

/**
 * Muestra modal de confirmaci√≥n personalizado.
 * 
 * @param {string} titulo - T√≠tulo del modal
 * @param {string} mensaje - Mensaje a mostrar
 * @param {Function} onConfirm - Funci√≥n a ejecutar al confirmar
 */
function mostrarModal(titulo, mensaje, onConfirm) {
  document.getElementById('modalTitle').textContent = titulo;
  document.getElementById('modalMessage').textContent = mensaje;
  document.getElementById('modalConfirm').classList.add('show');
  
  modalCallback = onConfirm;
}

/**
 * Cierra el modal de confirmaci√≥n.
 */
function cerrarModal() {
  document.getElementById('modalConfirm').classList.remove('show');
  modalCallback = null;
}

/**
 * Ejecuta la acci√≥n confirmada y cierra el modal.
 */
function confirmarModal() {
  // üîπ Guardar callback ANTES de cerrar (cerrarModal lo anula)
  const callback = modalCallback;
  
  cerrarModal();
  
  // üîπ Ejecutar el callback guardado
  if (callback && typeof callback === 'function') {
    callback();
  }
}
// MOD-002-013: FIN

</script>
<!-- MOD-002: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCI√ìN:
Frontend de CodeWorkShop. Captura c√≥digo, env√≠a al backend y muestra resultados.

VERSI√ìN: 01.37
- Agregado checkbox de reenumeraci√≥n para modo "Agregar MOD"
- Modificada configurarModoEdicion() para mostrar/ocultar checkbox seg√∫n modo
- Modificada aplicarCambioNuevo() v3 para capturar checkbox y pasar par√°metro al backend
- Actualizado ID checkReenum ‚Üí checkReenumEliminar para diferenciar de checkReenumAgregar
- Conservadas todas las funciones de visualizaci√≥n y eliminaci√≥n

RESPONSABILIDAD:
- Captura c√≥digo del usuario
- Env√≠a a code.gs para procesamiento
- Muestra resultados y estad√≠sticas
- Gestiona UI de Multi MOD, Agregar MOD (con reenumeraci√≥n) y Eliminar MOD (con reenumeraci√≥n)

INTEGRACI√ìN:
Backend code.gs v01.67:
- MOD-006 v7.0: Detecci√≥n ultra agn√≥stica + conteo de l√≠neas
- MOD-008 v4.0: Validaci√≥n din√°mica
- MOD-009 v6.0: Reemplazo ultra agn√≥stico
- MOD-014: reemplazarMultiplesModulos()
- MOD-015 v6.0: agregarModuloNuevo() con par√°metro reenumerar
- MOD-016: eliminarModulos() con par√°metro reenumerar

ESTADO:
Compatible con index.html v01.20
Compatible con backend ultra agn√≥stico v01.67
-->
<!-- MOD-099: FIN -->
