<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: CodeWorkShop
ARCHIVO: scripts.html
VERSIÓN: 01.16
FECHA: 18/01/2026 06:58 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: SCRIPT PRINCIPAL [INICIO] -->
<script>

  // MOD-002-S01: VARIABLES GLOBALES [INICIO]
  let codigoOriginal = '';
  let modulosDetectados = [];
  let moduloSeleccionado = null;
  // MOD-002-S01: FIN


  // MOD-002-S02: UTILIDADES GENERALES [INICIO]

  // UTILIDAD: ESCAPAR HTML (SOLO UI GENERAL)
  // ⚠️ NO USAR PARA MODS
  function escaparHTML(texto) {
    return texto
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }
  // MOD-002-S02: FIN


  // MOD-002-S03: ANALISIS DE MODULOS [INICIO]
  function analizarModulos() {
    const codigo = document.getElementById('codigoOriginal').value;

    if (!codigo.trim()) {
      mostrarNotificacion('⚠️ Carga un código primero', 'warning');
      return;
    }

    mostrarCargando(true);

    google.script.run
      .withSuccessHandler(res => {
        mostrarCargando(false);

        if (!res.success) {
          mostrarNotificacion(res.error, 'error');
          return;
        }

        codigoOriginal = codigo;
        modulosDetectados = res.modulos;

        mostrarModulos(modulosDetectados);
        mostrarNotificacion(`✅ ${res.modulos.length} MODs detectados`, 'success');
      })
      .withFailureHandler(() => {
        mostrarCargando(false);
        mostrarNotificacion('❌ Error al analizar', 'error');
      })
      .parsearModulos(codigo);
  }
  // MOD-002-S03: FIN

// MOD-002-S04: UI – LISTADO Y SELECCION DE MODS [INICIO]

function mostrarModulos(modulos) {
  const lista = document.getElementById('listaModulos');
  lista.innerHTML = '';

  modulos.forEach((mod, index) => {
    const item = document.createElement('div');
    item.className = 'modulo-item';
    item.onclick = () => seleccionarModulo(index);
    item.textContent = `${mod.id} ${mod.descripcion}`;
    lista.appendChild(item);
  });

  document.getElementById('seccionModulos').style.display = 'block';
  
  // Asegurar que la lista esté expandida al cargar
  const listaElement = document.getElementById('listaModulos');
  const btnCollapse = document.getElementById('btnCollapseModulos');
  listaElement.classList.remove('collapsed');
  btnCollapse.textContent = '▼';
}

function seleccionarModulo(index) {
  moduloSeleccionado = modulosDetectados[index];
  
  document.querySelectorAll('.modulo-item').forEach((el, i) => {
    el.classList.toggle('selected', i === index);
  });
  
  const campoActual = document.getElementById('moduloActual');
  campoActual.value = moduloSeleccionado.codigo;
  campoActual.readOnly = true;

  document.getElementById('seccionModuloActual').style.display = 'block';
  document.getElementById('seccionNuevoModulo').style.display = 'block';

  mostrarNotificacion(`ℹ️ ${moduloSeleccionado.id} seleccionado`, 'info');
}

function toggleModulos() {
  const lista = document.getElementById('listaModulos');
  const btnCollapse = document.getElementById('btnCollapseModulos');
  
  lista.classList.toggle('collapsed');
  
  if (lista.classList.contains('collapsed')) {
    btnCollapse.textContent = '▶';
  } else {
    btnCollapse.textContent = '▼';
  }
}

// MOD-002-S04: FIN

  // MOD-002-S05: REEMPLAZO DE MODULOS [INICIO]

  function aplicarCambio() {
    if (!codigoOriginal || !moduloSeleccionado) {
      mostrarNotificacion('⚠️ Falta código o módulo', 'warning');
      return;
    }

    const nuevoModulo = document.getElementById('nuevoModulo').value;
    mostrarCargando(true);

    google.script.run
      .withSuccessHandler(res => {
        mostrarCargando(false);

        if (!res.success) {
          mostrarNotificacion(res.error, 'error');
          return;
        }

        document.getElementById('codigoResultante').value = res.codigo;
        document.getElementById('seccionResultado').style.display = 'block';

        mostrarNotificacion('✅ Módulo reemplazado', 'success');
      })
      .withFailureHandler(() => {
        mostrarCargando(false);
        mostrarNotificacion('❌ Error al aplicar cambio', 'error');
      })
      .reemplazarModulo(
        codigoOriginal,
        moduloSeleccionado.id,
        nuevoModulo
      );
  }
  // MOD-002-S05: FIN


  // MOD-002-S06: UTILIDADES UI [INICIO]
  function copiarResultado() {
    navigator.clipboard.writeText(
      document.getElementById('codigoResultante').value
    );
  }

  function reiniciar() {
    codigoOriginal = '';
    modulosDetectados = [];
    moduloSeleccionado = null;
  }

  function mostrarNotificacion(msg, tipo = 'success') {
    const toast = document.getElementById('toast');
    toast.className = `toast ${tipo} show`;
    toast.textContent = msg;
    setTimeout(() => toast.className = 'toast', 3000);
  }

  function mostrarCargando(show) {
    document
      .getElementById('loading')
      .classList.toggle('show', show);
  }
  // MOD-002-S06: FIN


// MOD-002-S07: ACCIONES DE HEADER [INICIO]
  function copiarUrlPdfEstandar() {
    const urlPdf =
      'https://docs.google.com/document/d/1vbbaAPpTN9nQed_OOtoQBIp9K3PfNn5wgXWhNELAhqA/export?format=pdf';

    navigator.clipboard.writeText(urlPdf);
    mostrarNotificacion('✅ URL del estándar copiada', 'success');
  }

  function copiarInstruccionesIA() {
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.success) {
          mostrarNotificacion(
            res?.error || '❌ Error al obtener estándar',
            'error'
          );
          return;
        }

        navigator.clipboard.writeText(res.texto);
        mostrarNotificacion(
          '✅ Estándar copiado al portapapeles',
          'success'
        );
      })
      .withFailureHandler(() => {
        mostrarNotificacion(
          '❌ Error al leer el estándar',
          'error'
        );
      })
      .obtenerEstandar();
  }
  // MOD-002-S07: FIN


  // MOD-002-S08: LOG Y ARRANQUE [INICIO]
  console.log('✅ Scripts CodeWorkShop v2.7 cargados');
  // MOD-002-S08: FIN

</script>
<!-- MOD-002: FIN -->

<!-- MOD-003: NOTAS [INICIO] -->
<!--
scripts.html NO analiza código.
scripts.html NO modifica MODs.
scripts.html SOLO muestra y envía texto crudo.

Actualización:
Código remodulado con hijos en el script v01.14

Toda la lógica vive en:
- code.gs (MOD-006, MOD-008, MOD-009)
-->
<!-- MOD-003: FIN -->
