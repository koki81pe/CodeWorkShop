<!--
/******************************************
PROYECTO: CodeWorkShop
ARCHIVO: scripts.html
VERSI√ìN: 01.06
FECHA: 10/01/2026 (UTC-5)
******************************************/
-->
<script>
// Variables globales
let codigoOriginal = '';
let modulosDetectados = [];
let moduloSeleccionado = null;

// MOD-001: COPIAR EST√ÅNDAR DESDE GOOGLE DOC [INICIO]
function copiarInstruccionesIA() {
  mostrarCargando(true);
  console.log('üìã Obteniendo est√°ndar desde Google Doc...');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarCargando(false);
      
      if (!resultado.success) {
        mostrarNotificacion('‚ùå ' + resultado.error, 'error');
        console.error('Error al obtener est√°ndar:', resultado.error);
        return;
      }
      
      copiarTexto(resultado.texto);
      console.log('‚úÖ Est√°ndar obtenido correctamente');
    })
    .withFailureHandler(function(error) {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
      console.error('Error fatal al obtener est√°ndar:', error);
    })
    .obtenerEstandar();
}

function copiarTexto(texto) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(texto)
      .then(() => {
        mostrarNotificacion('‚úÖ Est√°ndar CodeWorkShop copiado', 'success');
        console.log('üìã Est√°ndar copiado al portapapeles');
      })
      .catch(() => {
        copiarTextoFallback(texto);
      });
  } else {
    copiarTextoFallback(texto);
  }
}

function copiarTextoFallback(texto) {
  const textarea = document.createElement('textarea');
  textarea.value = texto;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    const exitoso = document.execCommand('copy');
    if (exitoso) {
      mostrarNotificacion('‚úÖ Est√°ndar CodeWorkShop copiado', 'success');
      console.log('üìã Est√°ndar copiado (fallback)');
    } else {
      throw new Error('execCommand fall√≥');
    }
  } catch (err) {
    mostrarNotificacion('‚ùå No se pudo copiar. Usa Ctrl+C manualmente', 'error');
    console.error('Error al copiar:', err);
    mostrarModalEstandar(texto);
  } finally {
    document.body.removeChild(textarea);
  }
}

function mostrarModalEstandar(texto) {
  const modal = document.createElement('div');
  modal.className = 'modal-instrucciones';
  modal.innerHTML = `
    <div class="modal-content">
      <h3>üìã Est√°ndar CodeWorkShop</h3>
      <p>Selecciona todo el texto y copia con Ctrl+C:</p>
      <textarea readonly style="width:100%; height:400px; font-family:monospace;">
${texto}
      </textarea>
      <button onclick="this.closest('.modal-instrucciones').remove()">Cerrar</button>
    </div>
  `;
  document.body.appendChild(modal);
}
// MOD-001: FIN

// MOD-002: ANALIZAR M√ìDULOS [INICIO]
function analizarModulos() {
  const codigo = document.getElementById('codigoOriginal').value;
  
  if (!codigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Por favor, carga el c√≥digo primero', 'warning');
    return;
  }
  
  if (!codigo.includes('MOD-')) {
    mostrarNotificacion('‚ö†Ô∏è No se detectaron m√≥dulos en el c√≥digo', 'warning');
    return;
  }
  
  mostrarCargando(true);
  console.log('üì• C√≥digo cargado:', codigo.length, 'caracteres');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarCargando(false);
      
      if (!resultado.success) {
        mostrarNotificacion(resultado.error, 'error');
        console.error('Error al parsear:', resultado);
        return;
      }
      
      codigoOriginal = codigo;
      modulosDetectados = resultado.modulos;
      mostrarModulos(resultado.modulos);
      mostrarNotificacion('‚úÖ M√≥dulos detectados: ' + resultado.modulos.length, 'success');
      console.log('üîç M√≥dulos detectados:', resultado.modulos);
    })
    .withFailureHandler(function(error) {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
      console.error('Error fatal:', error);
    })
    .parsearModulos(codigo);
}
// MOD-002: FIN

// MOD-003: MOSTRAR M√ìDULOS [INICIO]
function mostrarModulos(modulos) {
  const lista = document.getElementById('listaModulos');
  lista.innerHTML = '';
  
  modulos.forEach((modulo, index) => {
    const item = document.createElement('div');
    item.className = 'modulo-item';
    item.onclick = () => seleccionarModulo(index);
    
    item.innerHTML = `
      <span class="modulo-numero">MOD-${modulo.numero}</span>
      <span class="modulo-descripcion">${modulo.descripcion}</span>
    `;
    
    lista.appendChild(item);
  });
  
  document.getElementById('seccionModulos').style.display = 'block';
}
// MOD-003: FIN

// MOD-004: SELECCIONAR M√ìDULO [INICIO]
function seleccionarModulo(index) {
  moduloSeleccionado = modulosDetectados[index];
  
  document.querySelectorAll('.modulo-item').forEach((item, i) => {
    if (i === index) {
      item.classList.add('selected');
    } else {
      item.classList.remove('selected');
    }
  });
  
  document.getElementById('moduloActual').value = moduloSeleccionado.codigo;
  document.getElementById('seccionModuloActual').style.display = 'block';
  document.getElementById('seccionNuevoModulo').style.display = 'block';
  
  mostrarNotificacion('‚úÖ M√≥dulo MOD-' + moduloSeleccionado.numero + ' seleccionado', 'info');
  console.log('üìå M√≥dulo seleccionado:', moduloSeleccionado);
}
// MOD-004: FIN

// MOD-005: APLICAR CAMBIO [INICIO]
function aplicarCambio() {
  if (!validarAntesDeEnviar()) {
    return;
  }
  
  const nuevoModulo = document.getElementById('nuevoModulo').value;
  
  mostrarCargando(true);
  console.log('üîÑ Aplicando cambio al m√≥dulo MOD-' + moduloSeleccionado.numero);
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarCargando(false);
      
      if (!resultado.success) {
        mostrarNotificacion(resultado.error, 'error');
        console.error('Error al reemplazar:', resultado);
        return;
      }
      
      document.getElementById('codigoResultante').value = resultado.codigo;
      document.getElementById('seccionResultado').style.display = 'block';
      mostrarNotificacion('‚úÖ Cambio aplicado correctamente', 'success');
      console.log('‚úÖ C√≥digo actualizado');
      
      document.getElementById('codigoResultante').scrollIntoView({ behavior: 'smooth' });
    })
    .withFailureHandler(function(error) {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al aplicar cambio', 'error');
      console.error('Error fatal:', error);
    })
    .reemplazarModulo(codigoOriginal, moduloSeleccionado.numero, nuevoModulo);
}
// MOD-005: FIN

// MOD-006: VALIDAR ANTES DE ENVIAR [INICIO]
function validarAntesDeEnviar() {
  if (!codigoOriginal) {
    mostrarNotificacion('‚ö†Ô∏è Primero carga el c√≥digo original', 'warning');
    return false;
  }
  
  if (!moduloSeleccionado) {
    mostrarNotificacion('‚ö†Ô∏è Selecciona un m√≥dulo', 'warning');
    return false;
  }
  
  const nuevoCodigo = document.getElementById('nuevoModulo').value;
  if (!nuevoCodigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è El nuevo c√≥digo est√° vac√≠o', 'warning');
    return false;
  }
  
  return true;
}
// MOD-006: FIN

// MOD-007: COPIAR RESULTADO [INICIO]
function copiarResultado() {
  const codigo = document.getElementById('codigoResultante').value;
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(codigo)
      .then(() => {
        mostrarNotificacion('‚úÖ C√≥digo copiado al portapapeles', 'success');
      })
      .catch(() => {
        copiarResultadoFallback();
      });
  } else {
    copiarResultadoFallback();
  }
}

function copiarResultadoFallback() {
  const textarea = document.getElementById('codigoResultante');
  textarea.select();
  
  try {
    document.execCommand('copy');
    mostrarNotificacion('‚úÖ C√≥digo copiado al portapapeles', 'success');
  } catch (err) {
    mostrarNotificacion('‚ùå No se pudo copiar', 'error');
  }
}
// MOD-007: FIN

// MOD-008: REINICIAR [INICIO]
function reiniciar() {
  document.getElementById('codigoOriginal').value = '';
  document.getElementById('nuevoModulo').value = '';
  document.getElementById('codigoResultante').value = '';
  
  document.getElementById('seccionModulos').style.display = 'none';
  document.getElementById('seccionModuloActual').style.display = 'none';
  document.getElementById('seccionNuevoModulo').style.display = 'none';
  document.getElementById('seccionResultado').style.display = 'none';
  
  codigoOriginal = '';
  modulosDetectados = [];
  moduloSeleccionado = null;
  
  mostrarNotificacion('üîÑ Listo para nueva modificaci√≥n', 'info');
  console.log('üîÑ Aplicaci√≥n reiniciada');
}
// MOD-008: FIN

// MOD-009: NOTIFICACIONES [INICIO]
function mostrarNotificacion(mensaje, tipo = 'success') {
  const toast = document.getElementById('toast');
  const iconos = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  toast.innerHTML = `${iconos[tipo]} ${mensaje}`;
  toast.className = `toast ${tipo} show`;
  
  setTimeout(() => {
    toast.className = 'toast';
  }, 3000);
}
// MOD-009: FIN

// MOD-010: LOADING OVERLAY [INICIO]
function mostrarCargando(mostrar) {
  const loading = document.getElementById('loading');
  if (mostrar) {
    loading.classList.add('show');
  } else {
    loading.classList.remove('show');
  }
}
// MOD-010: FIN

// MOD-011: ABRIR P√ÅGINA DE TESTS [INICIO]
function abrirTests() {
  google.script.run
    .withSuccessHandler(function(url) {
      if (url) {
        window.open(url, '_blank');
        console.log('üß™ Abriendo tests en:', url);
      } else {
        mostrarNotificacion('‚ùå No se pudo obtener la URL', 'error');
      }
    })
    .withFailureHandler(function(error) {
      mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
      console.error('Error al abrir tests:', error);
    })
    .obtenerURLTests();
}
// MOD-011: FIN
</script>
