<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: CodeWorkShop
ARCHIVO: scripts.html
VERSI√ìN: 01.07
FECHA: 10/01/2026 15:50 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: APERTURA SCRIPT [INICIO] -->
<script>
<!-- MOD-002: FIN -->

<!-- MOD-003: VARIABLES GLOBALES [INICIO] -->
<!-- Variables de estado de la aplicaci√≥n -->
let codigoOriginal = '';
let modulosDetectados = [];
let moduloSeleccionado = null;
<!-- MOD-003: FIN -->

<!-- MOD-004: COPIAR EST√ÅNDAR DESDE GOOGLE DOC [INICIO] -->
function copiarInstruccionesIA() {
  mostrarCargando(true);
  console.log('üìã Obteniendo est√°ndar desde Google Doc...');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarCargando(false);
      
      if (!resultado.success) {
        mostrarNotificacion('‚ùå ' + resultado.error, 'error');
        console.error('Error al obtener est√°ndar:', resultado.error);
        return;
      }
      
      copiarTexto(resultado.texto);
      console.log('‚úÖ Est√°ndar obtenido correctamente');
    })
    .withFailureHandler(function(error) {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
      console.error('Error fatal al obtener est√°ndar:', error);
    })
    .obtenerEstandar();
}

function copiarTexto(texto) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(texto)
      .then(() => {
        mostrarNotificacion('‚úÖ Est√°ndar CodeWorkShop copiado', 'success');
        console.log('üìã Est√°ndar copiado al portapapeles');
      })
      .catch(() => {
        copiarTextoFallback(texto);
      });
  } else {
    copiarTextoFallback(texto);
  }
}

function copiarTextoFallback(texto) {
  const textarea = document.createElement('textarea');
  textarea.value = texto;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    const exitoso = document.execCommand('copy');
    if (exitoso) {
      mostrarNotificacion('‚úÖ Est√°ndar CodeWorkShop copiado', 'success');
      console.log('üìã Est√°ndar copiado (fallback)');
    } else {
      throw new Error('execCommand fall√≥');
    }
  } catch (err) {
    mostrarNotificacion('‚ùå No se pudo copiar. Usa Ctrl+C manualmente', 'error');
    console.error('Error al copiar:', err);
    mostrarModalEstandar(texto);
  } finally {
    document.body.removeChild(textarea);
  }
}

function mostrarModalEstandar(texto) {
  const modal = document.createElement('div');
  modal.className = 'modal-instrucciones';
  modal.innerHTML = `
    <div class="modal-content">
      <h3>üìã Est√°ndar CodeWorkShop</h3>
      <p>Selecciona todo el texto y copia con Ctrl+C:</p>
      <textarea readonly style="width:100%; height:400px; font-family:monospace;">
${texto}
      </textarea>
      <button onclick="this.closest('.modal-instrucciones').remove()">Cerrar</button>
    </div>
  `;
  document.body.appendChild(modal);
}
<!-- MOD-004: FIN -->

<!-- MOD-005: ANALIZAR M√ìDULOS [INICIO] -->
function analizarModulos() {
  const codigo = document.getElementById('codigoOriginal').value;
  
  if (!codigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Por favor, carga el c√≥digo primero', 'warning');
    return;
  }
  
  if (!codigo.includes('MOD-')) {
    mostrarNotificacion('‚ö†Ô∏è No se detectaron m√≥dulos en el c√≥digo', 'warning');
    return;
  }
  
  mostrarCargando(true);
  console.log('üì• C√≥digo cargado:', codigo.length, 'caracteres');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarCargando(false);
      
      if (!resultado.success) {
        mostrarNotificacion(resultado.error, 'error');
        console.error('Error al parsear:', resultado);
        return;
      }
      
      codigoOriginal = codigo;
      modulosDetectados = resultado.modulos;
      mostrarModulos(resultado.modulos);
      
      <!-- Mostrar tipo de archivo detectado -->
      const tipoMensaje = resultado.tipo === 'html' ? 'HTML' : 'GS';
      mostrarNotificacion('‚úÖ M√≥dulos detectados: ' + resultado.modulos.length + ' (tipo: ' + tipoMensaje + ')', 'success');
      console.log('üîç M√≥dulos detectados:', resultado.modulos);
      console.log('üìÑ Tipo de archivo:', resultado.tipo);
    })
    .withFailureHandler(function(error) {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
      console.error('Error fatal:', error);
    })
    .parsearModulos(codigo);
}
<!-- MOD-005: FIN -->

<!-- MOD-006: MOSTRAR M√ìDULOS [INICIO] -->
function mostrarModulos(modulos) {
  const lista = document.getElementById('listaModulos');
  lista.innerHTML = '';
  
  modulos.forEach((modulo, index) => {
    const item = document.createElement('div');
    item.className = 'modulo-item';
    item.onclick = () => seleccionarModulo(index);
    
    <!-- Agregar badge del tipo de archivo -->
    const tipoBadge = modulo.tipo === 'html' 
      ? '<span style="font-size:10px;opacity:0.7;margin-left:8px;">HTML</span>' 
      : '<span style="font-size:10px;opacity:0.7;margin-left:8px;">GS</span>';
    
    item.innerHTML = `
      <span class="modulo-numero">MOD-${modulo.numero}${tipoBadge}</span>
      <span class="modulo-descripcion">${modulo.descripcion}</span>
    `;
    
    lista.appendChild(item);
  });
  
  document.getElementById('seccionModulos').style.display = 'block';
}
<!-- MOD-006: FIN -->

<!-- MOD-007: SELECCIONAR M√ìDULO [INICIO] -->
function seleccionarModulo(index) {
  moduloSeleccionado = modulosDetectados[index];
  
  document.querySelectorAll('.modulo-item').forEach((item, i) => {
    if (i === index) {
      item.classList.add('selected');
    } else {
      item.classList.remove('selected');
    }
  });
  
  document.getElementById('moduloActual').value = moduloSeleccionado.codigo;
  document.getElementById('seccionModuloActual').style.display = 'block';
  document.getElementById('seccionNuevoModulo').style.display = 'block';
  
  mostrarNotificacion('‚úÖ M√≥dulo MOD-' + moduloSeleccionado.numero + ' seleccionado', 'info');
  console.log('üìå M√≥dulo seleccionado:', moduloSeleccionado);
}
<!-- MOD-007: FIN -->

<!-- MOD-008: APLICAR CAMBIO [INICIO] -->
function aplicarCambio() {
  if (!validarAntesDeEnviar()) {
    return;
  }
  
  const nuevoModulo = document.getElementById('nuevoModulo').value;
  
  mostrarCargando(true);
  console.log('üîÑ Aplicando cambio al m√≥dulo MOD-' + moduloSeleccionado.numero);
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarCargando(false);
      
      if (!resultado.success) {
        mostrarNotificacion(resultado.error, 'error');
        console.error('Error al reemplazar:', resultado);
        return;
      }
      
      document.getElementById('codigoResultante').value = resultado.codigo;
      document.getElementById('seccionResultado').style.display = 'block';
      mostrarNotificacion('‚úÖ Cambio aplicado correctamente', 'success');
      console.log('‚úÖ C√≥digo actualizado');
      
      document.getElementById('codigoResultante').scrollIntoView({ behavior: 'smooth' });
    })
    .withFailureHandler(function(error) {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al aplicar cambio', 'error');
      console.error('Error fatal:', error);
    })
    .reemplazarModulo(codigoOriginal, moduloSeleccionado.numero, nuevoModulo);
}
<!-- MOD-008: FIN -->

<!-- MOD-009: VALIDAR ANTES DE ENVIAR [INICIO] -->
function validarAntesDeEnviar() {
  if (!codigoOriginal) {
    mostrarNotificacion('‚ö†Ô∏è Primero carga el c√≥digo original', 'warning');
    return false;
  }
  
  if (!moduloSeleccionado) {
    mostrarNotificacion('‚ö†Ô∏è Selecciona un m√≥dulo', 'warning');
    return false;
  }
  
  const nuevoCodigo = document.getElementById('nuevoModulo').value;
  if (!nuevoCodigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è El nuevo c√≥digo est√° vac√≠o', 'warning');
    return false;
  }
  
  return true;
}
<!-- MOD-009: FIN -->

<!-- MOD-010: COPIAR RESULTADO [INICIO] -->
function copiarResultado() {
  const codigo = document.getElementById('codigoResultante').value;
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(codigo)
      .then(() => {
        mostrarNotificacion('‚úÖ C√≥digo copiado al portapapeles', 'success');
      })
      .catch(() => {
        copiarResultadoFallback();
      });
  } else {
    copiarResultadoFallback();
  }
}

function copiarResultadoFallback() {
  const textarea = document.getElementById('codigoResultante');
  textarea.select();
  
  try {
    document.execCommand('copy');
    mostrarNotificacion('‚úÖ C√≥digo copiado al portapapeles', 'success');
  } catch (err) {
    mostrarNotificacion('‚ùå No se pudo copiar', 'error');
  }
}
<!-- MOD-010: FIN -->

<!-- MOD-011: REINICIAR [INICIO] -->
function reiniciar() {
  document.getElementById('codigoOriginal').value = '';
  document.getElementById('nuevoModulo').value = '';
  document.getElementById('codigoResultante').value = '';
  
  document.getElementById('seccionModulos').style.display = 'none';
  document.getElementById('seccionModuloActual').style.display = 'none';
  document.getElementById('seccionNuevoModulo').style.display = 'none';
  document.getElementById('seccionResultado').style.display = 'none';
  
  codigoOriginal = '';
  modulosDetectados = [];
  moduloSeleccionado = null;
  
  mostrarNotificacion('üîÑ Listo para nueva modificaci√≥n', 'info');
  console.log('üîÑ Aplicaci√≥n reiniciada');
}
<!-- MOD-011: FIN -->

<!-- MOD-012: NOTIFICACIONES [INICIO] -->
function mostrarNotificacion(mensaje, tipo = 'success') {
  const toast = document.getElementById('toast');
  const iconos = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  toast.innerHTML = `${iconos[tipo]} ${mensaje}`;
  toast.className = `toast ${tipo} show`;
  
  setTimeout(() => {
    toast.className = 'toast';
  }, 3000);
}
<!-- MOD-012: FIN -->

<!-- MOD-013: LOADING OVERLAY [INICIO] -->
function mostrarCargando(mostrar) {
  const loading = document.getElementById('loading');
  if (mostrar) {
    loading.classList.add('show');
  } else {
    loading.classList.remove('show');
  }
}
<!-- MOD-013: FIN -->

<!-- MOD-014: ABRIR P√ÅGINA DE TESTS [INICIO] -->
function abrirTests() {
  google.script.run
    .withSuccessHandler(function(url) {
      if (url) {
        window.open(url, '_blank');
        console.log('üß™ Abriendo tests en:', url);
      } else {
        mostrarNotificacion('‚ùå No se pudo obtener la URL', 'error');
      }
    })
    .withFailureHandler(function(error) {
      mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
      console.error('Error al abrir tests:', error);
    })
    .obtenerURLTests();
}
<!-- MOD-014: FIN -->

<!-- MOD-015: C√ìDIGO DE CIERRE [INICIO] -->
<!-- Inicializaci√≥n completada -->
console.log('‚úÖ Scripts de CodeWorkShop cargados');
console.log('üìã Soporta archivos .GS y .HTML (CodeWorkshop v2.2)');
<!-- MOD-015: FIN -->

<!-- MOD-016: CIERRE SCRIPT [INICIO] -->
</script>
<!-- MOD-016: FIN -->

<!-- MOD-017: NOTAS [INICIO] -->
<!--
DESCRIPCI√ìN:
Scripts frontend de CodeWorkShop para la interfaz de usuario.
Maneja la interacci√≥n con el backend, visualizaci√≥n de m√≥dulos,
y gesti√≥n del flujo de trabajo de modificaci√≥n modular.

CAMBIOS EN v01.07 (CR√çTICO):
- Cumple con est√°ndar CodeWorkshop v2.2 para archivos HTML
- TODOS los comentarios usan sintaxis HTML: |
- MOD-003: Variables globales ahora est√°n en su propio m√≥dulo
- MOD-005: Ahora muestra el tipo de archivo detectado (GS/HTML)
- MOD-006: Agrega badge visual para identificar tipo de m√≥dulo
- MOD-016: M√≥dulo de cierre de script agregado
- MOD-017: M√≥dulo de NOTAS agregado

DEPENDENCIAS:
- MOD-004: Requiere obtenerEstandar() del backend (code.gs MOD-012)
- MOD-005: Requiere parsearModulos() del backend (code.gs MOD-006)
- MOD-008: Requiere reemplazarModulo() del backend (code.gs MOD-009)
- MOD-014: Requiere obtenerURLTests() del backend (code.gs MOD-011)
- Todos los m√≥dulos requieren elementos HTML de index.html

ADVERTENCIAS:
- MOD-005: Valida que el c√≥digo contenga 'MOD-' antes de enviar al backend
- MOD-006: El badge de tipo se muestra solo si el m√≥dulo tiene propiedad 'tipo'
- MOD-009: La validaci√≥n es b√°sica, el backend hace validaci√≥n m√°s estricta
- MOD-012: Los toasts se ocultan autom√°ticamente despu√©s de 3 segundos

ESTRUCTURA DE M√ìDULOS:
- MOD-001: Encabezado con metadata del archivo
- MOD-002: Apertura del tag script
- MOD-003: Variables globales
- MOD-004 a MOD-014: Funciones de la aplicaci√≥n
- MOD-015: C√≥digo de cierre (logs de inicializaci√≥n)
- MOD-016: Cierre del tag script
- MOD-017: Notas y documentaci√≥n (este m√≥dulo)

PR√ìXIMAS MEJORAS:
- Agregar validaci√≥n de sintaxis en el cliente antes de enviar
- Implementar preview del cambio antes de aplicar
- Agregar historial de cambios (undo/redo)
- Mejorar visualizaci√≥n de diferencias entre m√≥dulo original y nuevo
-->
<!-- MOD-017: FIN -->
